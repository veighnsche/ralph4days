# Anti-Gaming Specification

| Field | Value |
|-------|-------|
| **Spec ID** | SPEC-020 |
| **Title** | Anti-Gaming Specification |
| **Status** | Active |
| **Version** | 1.0.0 |
| **Created** | 2026-02-05 |
| **Author** | Vince Liem |
| **Co-Author** | Claude Opus 4.5 |

---

## 1. Purpose

This specification defines rules and structural constraints that prevent AI agents (and humans) from "reward hacking" â€” satisfying requirements in letter but not spirit.

**Goal:** Make doing the right thing easier than gaming the system.

## 2. Scope

This specification covers:
- Specification integrity rules
- Implementation verification requirements
- Test validity requirements

## 3. Definitions

| Term | Definition |
|------|------------|
| **Reward Hacking** | Satisfying metrics/requirements through unintended shortcuts that don't fulfill actual goals |
| **Gaming** | Exploiting ambiguity or loopholes in specifications |
| **Golden Test** | Test against known-good reference data that cannot be generated by the system under test |
| **Behavioral Test** | Test that verifies observable outcomes, not implementation details |
| **Stub** | A minimal implementation that compiles but does not function |

## 4. Threat Model

### 4.1 AI Agent Attack Vectors

| Vector | Description | Impact |
|--------|-------------|--------|
| **Spec Manipulation** | Write vague specs anything can satisfy | Requirements meaningless |
| **Circular Validation** | Implementation defines what "correct" means | No external truth |
| **Test Tautology** | Tests verify what code does, not what it should do | False confidence |
| **Stub Completion** | `return Ok(())` for everything | Non-functional code |
| **Metric Gaming** | Optimize for coverage numbers, not correctness | Hidden bugs |

## 5. Specification Integrity

### REQ-020-01: Immutable Active Specs

Specifications with Status=Active MUST NOT be modified to accommodate implementation.

| Traces To | `.specs/*` files, git history |
| Tested By | Git hooks, PR review |
| Rationale | Prevents changing spec to match broken code |

**Allowed changes to Active specs:**
- Clarifications that don't change requirements
- Adding new requirements (minor version bump)
- Fixing typos

**Prohibited:**
- Weakening MUST to SHOULD
- Removing requirements
- Broadening definitions to accept invalid behavior

### REQ-020-02: Atomic Requirements

Each requirement MUST be independently testable with a single pass/fail outcome.

| Traces To | Requirement format in SPEC-000 |
| Tested By | Manual review |
| Rationale | Prevents compound requirements where partial compliance is ambiguous |

**Bad:**
> The loop engine MUST start, run iterations, and handle errors correctly.

**Good:**
> REQ-X-01: The loop engine MUST validate project path exists before starting.
> REQ-X-02: The loop engine MUST emit StateChanged event on state transitions.
> REQ-X-03: The loop engine MUST return error if .ralph directory is missing.

### REQ-020-03: No Self-Referential Definitions

Requirements MUST NOT define correctness in terms of implementation behavior.

| Traces To | Requirement language |
| Tested By | Manual review |
| Rationale | Prevents circular "correct = whatever the code does" |

**Bad:**
> The output is valid if the loop produces it without error.

**Good:**
> The output is valid if it contains the Claude response text.

## 6. Implementation Verification

### REQ-020-04: Behavioral Tests Required

Every major feature MUST have behavioral tests that verify observable outcomes.

| Traces To | Test files |
| Tested By | CI, mutation testing |
| Rationale | Prevents stub implementations that compile but don't work |

**Behavioral test criteria:**
- Tests actual I/O (files, IPC, UI events)
- Verifies output content, not just existence
- Uses realistic inputs, not contrived examples
- Fails if implementation is stubbed

## 7. Test Validity

### REQ-020-05: No Tautological Tests

Tests MUST NOT verify that code does what it does; they MUST verify it does what it SHOULD.

| Traces To | Test code |
| Tested By | Code review, mutation testing |
| Rationale | Prevents tests that pass regardless of correctness |

**Tautological (BAD):**
```typescript
test('store updates state', () => {
    store.setState({ state: 'running' });
    expect(store.getState().state).toBe('running'); // Just checks setter works
});
```

**Meaningful (GOOD):**
```typescript
test('starting loop transitions to running state', async () => {
    await invoke('start_loop', { projectPath: '/test', maxIterations: 10 });
    const state = await invoke('get_loop_state');
    expect(state.state).toBe('running');
});
```

### REQ-020-06: Test Independence

Tests MUST NOT depend on other tests or shared mutable state.

| Traces To | Test code |
| Tested By | Test randomization, parallel execution |
| Rationale | Prevents tests that pass only in specific order |

## 8. Requirements Summary

| Req ID | Requirement | Priority |
|--------|-------------|----------|
| REQ-020-01 | Active specs immutable | MUST |
| REQ-020-02 | Requirements atomic | MUST |
| REQ-020-03 | No self-referential definitions | MUST |
| REQ-020-04 | Behavioral tests required | MUST |
| REQ-020-05 | No tautological tests | MUST |
| REQ-020-06 | Test independence | MUST |

## Change Log

| Version | Date | Changes |
|---------|------|---------|
| 1.0.0 | 2026-02-05 | Initial specification adapted from iuppiter-dar |
